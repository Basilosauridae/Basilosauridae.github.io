<template><div><h1 id="将植物大战僵尸安卓版游戏存档路径改到外部存储下-以谷歌free版为例" tabindex="-1"><a class="header-anchor" href="#将植物大战僵尸安卓版游戏存档路径改到外部存储下-以谷歌free版为例" aria-hidden="true">#</a> 将植物大战僵尸安卓版游戏存档路径改到外部存储下（以谷歌free版为例）</h1>
<h2 id="目标" tabindex="-1"><a class="header-anchor" href="#目标" aria-hidden="true">#</a> 目标</h2>
<p>现在游戏的存档路径为<code v-pre>/data/user/0/包名/files</code>，需要root才能访问，希望能改到<code v-pre>/storage/emulated/0/Android/data/包名/files</code>下，无需root即可访问</p>
<h2 id="需要了解" tabindex="-1"><a class="header-anchor" href="#需要了解" aria-hidden="true">#</a> 需要了解</h2>
<ul>
<li>java</li>
<li>smali</li>
<li>dex</li>
<li>jadx</li>
<li>mt管理器</li>
</ul>
<h2 id="思考" tabindex="-1"><a class="header-anchor" href="#思考" aria-hidden="true">#</a> 思考</h2>
<ol>
<li>因为不会改so，所以从dex入手</li>
<li>游戏写入存档文件，肯定要先获取存档文件所在的文件路径，那么找到这个函数，把返回值改为外部路径即可。（当然这是理想情况，也可能找不到这样的函数，也可能找到了但是改了没作用）</li>
<li>去网上搜索 <em>android获取数据路径的java函数</em>，找到了几个，使用测试apk输出一下，得到的路径如图所示<br>
<img src="@source/blogs/2022/summer/changeuserdataLocation/1.png" alt="图1"><br>
其中<code v-pre>com.example.datainsert</code>为测试apk的包名，那么对比目标，很明显游戏应该是用的是<code v-pre>getFilesDir()</code>，我想要改成的是<code v-pre>getExternalFilesDir(null)</code></li>
</ol>
<h2 id="实现" tabindex="-1"><a class="header-anchor" href="#实现" aria-hidden="true">#</a> 实现</h2>
<ol>
<li>
<p>使用jadx进行反编译。将pvzFree2.9.07拖入进去，然后搜索getfilesdir()，发现匹配到了非常多的结果。<br>
<img src="@source/blogs/2022/summer/changeuserdataLocation/2.png" alt="图2"><br>
但仔细观察前面的包名，会发现大部分都是安卓系统类或者广告类。</p>
</li>
<li>
<p>先去看一下apk的主activity，发现是<code v-pre>com.ea.game.pvzfree_row.pvzactivity</code>，那么需要改的地方在com.ea包下的可能性比较大</p>
</li>
<li>
<p>我先后改了com.ea包下的rwfilesystem，EAIO，EAMIO三个类里的代码，最后在改了EAMIO之后成功了。这里就以EAMIO为例说一下怎么改。</p>
</li>
<li>
<p>在1.中的搜索结果，点进去看一下getFilesDir代码所在位置。</p>
<div class="language-java ext-java line-numbers-mode"><pre v-pre class="language-java"><code><span class="token comment">//com.ea.EAMIO.StorageDirectory</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token class-name">GetInternalStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sActivity<span class="token punctuation">.</span><span class="token function">getFilesDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token class-name">GetPrimaryExternalStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sActivity<span class="token punctuation">.</span><span class="token function">getExternalFilesDir</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>好家伙，上面是getFilesDir，下面就是我们想要的getExternalFilesDir，那么直接复制粘贴到上面就行了。</p>
</li>
<li>
<p>打开mt管理器，进入dex编辑器++，找到对应类，复制粘贴对应函数内容。</p>
<div class="language-smali ext-smali line-numbers-mode"><pre v-pre class="language-smali"><code><span class="token comment">#com.ea.EAMIO.StorageDirectory</span>
<span class="token keyword">.method</span> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token function">GetInternalStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name"><span class="token builtin">L</span><span class="token namespace">java<span class="token punctuation">/</span>lang<span class="token punctuation">/</span></span><span class="token class-name">String</span></span><span class="token punctuation">;</span>
    <span class="token keyword">.registers</span> <span class="token number">2</span>

    <span class="token keyword">.line</span> <span class="token number">30</span>
    sget-object <span class="token register variable">v0</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token builtin">L</span><span class="token namespace">com<span class="token punctuation">/</span>ea<span class="token punctuation">/</span>EAMIO<span class="token punctuation">/</span></span><span class="token class-name">StorageDirectory</span></span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token field variable">sActivity</span><span class="token punctuation">:</span><span class="token class-name"><span class="token builtin">L</span><span class="token namespace">android<span class="token punctuation">/</span>app<span class="token punctuation">/</span></span><span class="token class-name">Activity</span></span><span class="token punctuation">;</span>

    const/4 <span class="token register variable">v1</span><span class="token punctuation">,</span> <span class="token number">0x0</span>

    invoke-virtual <span class="token punctuation">{</span><span class="token register variable">v0</span><span class="token punctuation">,</span> <span class="token register variable">v1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token builtin">L</span><span class="token namespace">android<span class="token punctuation">/</span>app<span class="token punctuation">/</span></span><span class="token class-name">Activity</span></span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">getExternalFilesDir</span><span class="token punctuation">(</span><span class="token class-name"><span class="token builtin">L</span><span class="token namespace">java<span class="token punctuation">/</span>lang<span class="token punctuation">/</span></span><span class="token class-name">String</span></span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name"><span class="token builtin">L</span><span class="token namespace">java<span class="token punctuation">/</span>io<span class="token punctuation">/</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>

    move-result-object <span class="token register variable">v0</span>

    invoke-virtual <span class="token punctuation">{</span><span class="token register variable">v0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token builtin">L</span><span class="token namespace">java<span class="token punctuation">/</span>io<span class="token punctuation">/</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name"><span class="token builtin">L</span><span class="token namespace">java<span class="token punctuation">/</span>lang<span class="token punctuation">/</span></span><span class="token class-name">String</span></span><span class="token punctuation">;</span>

    move-result-object <span class="token register variable">v0</span>

    return-object <span class="token register variable">v0</span>
<span class="token keyword">.end</span> <span class="token keyword">method</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改就完成了。顺便学习一下java里传参是null，smali里传的是0x0</p>
</li>
<li>
<p>复制现有的可运行的代码一般不会出问题。如果自己手写的话，需要注意一下开头的<code v-pre>.registers</code>个数是否足够，因为要一个v1传参。还有就是如果所在的函数比较长，然后用了现有的寄存器，应该看看这个寄存器之前是否存过什么值，之后是否还需要用到这个值，如果需要的话，记得用作传参null之后再把之前的值赋值回去。</p>
</li>
<li>
<p>除了修改调用的函数外，还可以暴力返回字符串常量，如<code v-pre>&quot;/storage/emulated/0/Android/data/com.ea.pvzfree_row/files&quot;</code>。但这样写一是路径错了不容易发现，二是官方文档说getFilesDir这样的函数，在不同情况下的返回值可能不同。也不知道是什么情况，但如果写死的话，可能会有风险，在某些情况下返回的值不符合要求无法识别吧。</p>
</li>
</ol>
<h2 id="效果" tabindex="-1"><a class="header-anchor" href="#效果" aria-hidden="true">#</a> 效果</h2>
<ul>
<li>保存dex，生成apk，安装后打开，发现存档文件出现在了期望的位置，如图<br>
<img src="@source/blogs/2022/summer/changeuserdataLocation/3.png" alt="图3"></li>
</ul>
</div></template>
